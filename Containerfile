# syntax=docker/dockerfile:1.7-labs
###############################################################################
#  infra-upstream bootc derivative                                            #
###############################################################################

###############################################################################
# ───────────── build-time arguments ───────────────────────────────────────── #
###############################################################################
ARG FLAVOR=bluefin              # default when building locally
ARG FEDORA_TAG=stable           # overridden in CI matrix

###############################################################################
# ───────────── base image ─────────────────────────────────────────────────── #
###############################################################################
FROM ghcr.io/ublue-os/${FLAVOR}:${FEDORA_TAG}

###############################################################################
# ───────────── image metadata ─────────────────────────────────────────────── #
###############################################################################
LABEL org.opencontainers.image.title="huntergerlach/infra-upstream" \
      org.opencontainers.image.source="https://github.com/HunterGerlach/infra-upstream"

###############################################################################
# ───────────── package layer ──────────────────────────────────────────────── #
#  ⚠ rpm-ostree needs elevated capabilities that are blocked on GH Actions.  #
#    Long-term we’ll migrate to a root-full DNF stage + `bootc commit`.       #
###############################################################################
RUN --mount=type=cache,target=/var/cache/dnf \
    rpm-ostree install \
        htop \
        git \
    && rpm-ostree cleanup -m

###############################################################################
# ───────────── finalise bootc ─────────────────────────────────────────────── #
###############################################################################
RUN bootc finalize

###############################################################################
# ───────────── runtime ────────────────────────────────────────────────────── #
###############################################################################
CMD ["/usr/bin/bash"]